
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>2.2. Advanced NumPy &#8212; Scipy lecture notes</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.3. Debugging code" href="../debugging/index.html" />
    <link rel="prev" title="2.1. Advanced Python Constructs" href="../advanced_python/index.html" />
   
    <link rel="stylesheet"
	  href="https://unpkg.com/purecss@1.0.0/build/base-min.css">

<script type="text/javascript">
$(function () {
    // Highlight the table of content as we scroll
    sections = {},
    i        = 0,
    url	 = document.URL.replace(/#.*$/, ""),
    current_section = 0;

    // Grab positions of our sections
    $('.headerlink').each(function(){
        sections[this.href.replace(url, '')] = $(this).offset().top - 50;
    });

    $(window).scroll(function(event) {
	var pos   = $(window).scrollTop();

	// Highlight the current section
	$('a.internal').parent().removeClass('active');
        for(i in sections){
            if(sections[i] > pos){
		break;
            };
	    if($('a.internal[href$="' + i + '"]').is(':visible')){
		current_section = i;
	    };
        }
	$('a.internal[href$="' + current_section + '"]').parent().addClass('active');
	$('a.internal[href$="' + current_section + '"]').parent().parent().parent().addClass('active');
	$('a.internal[href$="' + current_section + '"]').parent().parent().parent().parent().parent().addClass('active');
    });

});
</script>


  </head><body>
   <!-- Use the header to add javascript -->
    

    <script type="text/javascript">
    // Function to collapse the tip divs
    function collapse_tip_div(obj){
	// Update the representation on the tip div based on whether it
	// has the 'collapsed' css class or not: we only want to
	// collapse divs that are not already collapsed
	if($(obj).hasClass("collapsed")) {
	} else {
	    $(obj).find("p.summary").remove();
	    var content = $(obj).text();
	    var html = $(obj).html();

	    if(content.length > 40) {
		if ($.browser.msie) {
		    // We start at '3' to avoid 'tip', as IE
		    // does not count whitespace
		    var content = content.substr(3, 50);
		} else {
		    // We start at '5' to avoid 'tip '
		    var content = content.substr(5, 50);
		}
	    }
	    $(obj).html('<p class="summary"><img src="../../_static/plus.png">' + content + '...</p>' + html);
	}
    }
    </script>

    <script type="text/javascript">
    $(function () {
	$(".tip")
	    .click(function(event){
		$(this).toggleClass("collapsed");
		// Change state of the global button
		$('div.related li.transparent').removeClass('transparent')
		$(this).find("p.summary").remove();
		if($(this).hasClass("collapsed")) {
		    var content = $(this).text();
		    var html = $(this).html();

		    if(content.length > 40) {
			if ($.browser.msie) {
			    // We start at '3' to avoid 'tip', as IE
			    // does not count whitespace
			    var content = content.substr(3, 50);
			} else {
			    // We start at '5' to avoid 'tip '
			    var content = content.substr(5, 50);
			}
		    }
		    $(this).html('<p class="summary"><img src="../../_static/plus.png">' + content + '...</p>' + html);
		}
		if (event.target.tagName.toLowerCase() != "a") {
                   return true; //Makes links clickable
		}
	});
    });
    </script>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../debugging/index.html" title="2.3. Debugging code"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="../advanced_python/index.html" title="2.1. Advanced Python Constructs"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Scipy lecture notes</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">2. Advanced topics</a> &#187;</li>
     
    <!-- Insert a menu in the navigation bar -->
    <li class="left">
	<!-- On click toggle the 'tip' on or off-->
	<a onclick="$('.tip').each(function (index, obj) {
			    collapse_tip_div(obj);
		    });
		    $('.tip').addClass('collapsed');
		    $('.left').addClass('transparent');">
	<img src="../../_static/minus.png"
         alt="Collapse to compact view" style="padding: 1ex;"/>
	<span class="hiddenlink">Collapse document to compact view</span>
    </a></li>
    <li class="right edit_on_github"><a href="https://github.com/scipy-lectures/scipy-lecture-notes/edit/master/advanced/advanced_numpy/index.rst">Edit
    <span class="tooltip">
	Improve this page:<br/>Edit it on Github.
    </span>
    </a>
    </li>

      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="advanced-numpy">
<span id="id1"></span><h1>2.2. Advanced NumPy<a class="headerlink" href="#advanced-numpy" title="Permalink to this headline">¶</a></h1>
<p><strong>Author</strong>: <em>Pauli Virtanen</em></p>
<p>NumPy is at the base of Python’s scientific stack of tools. Its purpose
to implement efficient operations on many items in a block of memory.
Understanding how it works in detail helps in making efficient use of its
flexibility, taking useful shortcuts.</p>
<p>This section covers:</p>
<ul class="simple">
<li>Anatomy of NumPy arrays, and its consequences. Tips and
tricks.</li>
<li>Universal functions: what, why, and what to do if you want
a new one.</li>
<li>Integration with other tools: NumPy offers several ways to
wrap any data in an ndarray, without unnecessary copies.</li>
<li>Recently added features, and what’s in them: PEP
3118 buffers, generalized ufuncs, …</li>
</ul>
<div class="topic">
<p class="topic-title">Prerequisites</p>
<ul class="simple">
<li>NumPy</li>
<li>Cython</li>
<li>Pillow (Python imaging library, used in a couple of examples)</li>
</ul>
</div>
<div class="contents local topic" id="chapter-contents">
<p class="topic-title">Chapter contents</p>
<ul class="simple">
<li><a class="reference internal" href="#life-of-ndarray" id="id3">Life of ndarray</a><ul>
<li><a class="reference internal" href="#it-s" id="id4">It’s…</a></li>
<li><a class="reference internal" href="#block-of-memory" id="id5">Block of memory</a></li>
<li><a class="reference internal" href="#data-types" id="id6">Data types</a></li>
<li><a class="reference internal" href="#indexing-scheme-strides" id="id7">Indexing scheme: strides</a></li>
<li><a class="reference internal" href="#findings-in-dissection" id="id8">Findings in dissection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#universal-functions" id="id9">Universal functions</a><ul>
<li><a class="reference internal" href="#what-they-are" id="id10">What they are?</a></li>
<li><a class="reference internal" href="#exercise-building-an-ufunc-from-scratch" id="id11">Exercise: building an ufunc from scratch</a></li>
<li><a class="reference internal" href="#solution-building-an-ufunc-from-scratch" id="id12">Solution: building an ufunc from scratch</a></li>
<li><a class="reference internal" href="#generalized-ufuncs" id="id13">Generalized ufuncs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#interoperability-features" id="id14">Interoperability features</a><ul>
<li><a class="reference internal" href="#sharing-multidimensional-typed-data" id="id15">Sharing multidimensional, typed data</a></li>
<li><a class="reference internal" href="#the-old-buffer-protocol" id="id16">The old buffer protocol</a></li>
<li><a class="reference internal" href="#id2" id="id17">The old buffer protocol</a></li>
<li><a class="reference internal" href="#array-interface-protocol" id="id18">Array interface protocol</a></li>
</ul>
</li>
<li><a class="reference internal" href="#array-siblings-chararray-maskedarray-matrix" id="id19">Array siblings: <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.chararray.html#numpy.chararray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">chararray</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">maskedarray</span></code>, <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.matrix.html#numpy.matrix" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">matrix</span></code></a></a><ul>
<li><a class="reference internal" href="#chararray-vectorized-string-operations" id="id20"><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.chararray.html#numpy.chararray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">chararray</span></code></a>: vectorized string operations</a></li>
<li><a class="reference internal" href="#masked-array-missing-data" id="id21"><code class="xref py py-class docutils literal notranslate"><span class="pre">masked_array</span></code> missing data</a></li>
<li><a class="reference internal" href="#recarray-purely-convenience" id="id22"><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.recarray.html#numpy.recarray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">recarray</span></code></a>: purely convenience</a></li>
<li><a class="reference internal" href="#matrix-convenience" id="id23"><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.matrix.html#numpy.matrix" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">matrix</span></code></a>: convenience?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary" id="id24">Summary</a></li>
<li><a class="reference internal" href="#contributing-to-numpy-scipy" id="id25">Contributing to NumPy/Scipy</a><ul>
<li><a class="reference internal" href="#why" id="id26">Why</a></li>
<li><a class="reference internal" href="#reporting-bugs" id="id27">Reporting bugs</a></li>
<li><a class="reference internal" href="#contributing-to-documentation" id="id28">Contributing to documentation</a></li>
<li><a class="reference internal" href="#contributing-features" id="id29">Contributing features</a></li>
<li><a class="reference internal" href="#how-to-help-in-general" id="id30">How to help, in general</a></li>
</ul>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>In this section, numpy will be imported as follows:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="life-of-ndarray">
<h2><a class="toc-backref" href="#id3">2.2.1. Life of ndarray</a><a class="headerlink" href="#life-of-ndarray" title="Permalink to this headline">¶</a></h2>
<div class="section" id="it-s">
<h3><a class="toc-backref" href="#id4">2.2.1.1. It’s…</a><a class="headerlink" href="#it-s" title="Permalink to this headline">¶</a></h3>
<p><strong>ndarray</strong> =</p>
<blockquote>
<div><p>block of memory + indexing scheme + data type descriptor</p>
<ul class="simple">
<li>raw data</li>
<li>how to locate an element</li>
<li>how to interpret an element</li>
</ul>
</div></blockquote>
<img alt="../../_images/threefundamental.png" src="../../_images/threefundamental.png" />
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyArrayObject</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">PyObject_HEAD</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">        </span><span class="cm">/* Block of memory */</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">        </span><span class="cm">/* Data type descriptor */</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">PyArray_Descr</span><span class="w"> </span><span class="o">*</span><span class="n">descr</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">        </span><span class="cm">/* Indexing scheme */</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">strides</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">        </span><span class="cm">/* Other stuff */</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">weakreflist</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div><span class="p">}</span><span class="w"> </span><span class="n">PyArrayObject</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="block-of-memory">
<h3><a class="toc-backref" href="#id5">2.2.1.2. Block of memory</a><a class="headerlink" href="#block-of-memory" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">data</span>      
<div class="newline"></div><span class="go">&lt;... at ...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">bytes</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  
<div class="newline"></div><span class="go">&#39;\x01\x00\x00\x00\x02\x00\x00\x00\x03\x00\x00\x00&#39;</span>
<div class="newline"></div></pre></div>
</div>
<p>Memory address of the data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
<div class="newline"></div><span class="go">64803824</span>
<div class="newline"></div></pre></div>
</div>
<p>The whole <code class="docutils literal notranslate"><span class="pre">__array_interface__</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">__array_interface__</span>  
<div class="newline"></div><span class="go">{&#39;data&#39;: (35828928, False),</span>
<div class="newline"></div><span class="go"> &#39;descr&#39;: [(&#39;&#39;, &#39;&lt;i4&#39;)],</span>
<div class="newline"></div><span class="go"> &#39;shape&#39;: (4,),</span>
<div class="newline"></div><span class="go"> &#39;strides&#39;: None,</span>
<div class="newline"></div><span class="go"> &#39;typestr&#39;: &#39;&lt;i4&#39;,</span>
<div class="newline"></div><span class="go"> &#39;version&#39;: 3}</span>
<div class="newline"></div></pre></div>
</div>
<p>Reminder: two <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarrays</span></code></a> may share the same memory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([9, 2, 3])</span>
<div class="newline"></div></pre></div>
</div>
<p>Memory does not need to be owned by an <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;1234&#39;</span>      <span class="c1"># The &#39;b&#39; is for &quot;bytes&quot;, necessary in Python 3</span>
<div class="newline"></div></pre></div>
</div>
<p>x is a string (in Python 3 a bytes), we can represent its data as an
array of ints:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">data</span>      
<div class="newline"></div><span class="go">&lt;... at ...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">x</span>
<div class="newline"></div><span class="go">True</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">flags</span>
<div class="newline"></div><span class="go">  C_CONTIGUOUS : True</span>
<div class="newline"></div><span class="go">  F_CONTIGUOUS : True</span>
<div class="newline"></div><span class="go">  OWNDATA : False</span>
<div class="newline"></div><span class="go">  WRITEABLE : False</span>
<div class="newline"></div><span class="go">  ALIGNED : True</span>
<div class="newline"></div><span class="go">  WRITEBACKIFCOPY : False</span>
<div class="newline"></div><span class="go">  UPDATEIFCOPY : False</span>
<div class="newline"></div></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">owndata</span></code> and <code class="docutils literal notranslate"><span class="pre">writeable</span></code> flags indicate status of the memory
block.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="http://numpy.org/doc/stable/reference/arrays.interface.html">array interface</a></p>
</div>
</div>
<div class="section" id="data-types">
<h3><a class="toc-backref" href="#id6">2.2.1.3. Data types</a><a class="headerlink" href="#data-types" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-descriptor">
<h4>The descriptor<a class="headerlink" href="#the-descriptor" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.dtype.html#numpy.dtype" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">dtype</span></code></a> describes a single item in the array:</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>type</td>
<td><p class="first"><strong>scalar type</strong> of the data, one of:</p>
<p>int8, int16, float64, <em>et al.</em>  (fixed size)</p>
<p class="last">str, unicode, void   (flexible size)</p>
</td>
</tr>
<tr class="row-even"><td>itemsize</td>
<td><strong>size</strong> of the data block</td>
</tr>
<tr class="row-odd"><td>byteorder</td>
<td><strong>byte order</strong>: big-endian <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> / little-endian <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> / not applicable <code class="docutils literal notranslate"><span class="pre">|</span></code></td>
</tr>
<tr class="row-even"><td>fields</td>
<td>sub-dtypes, if it’s a <strong>structured data type</strong></td>
</tr>
<tr class="row-odd"><td>shape</td>
<td>shape of the array, if it’s a <strong>sub-array</strong></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>      
<div class="newline"></div><span class="go">&lt;type &#39;numpy.int64&#39;&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
<div class="newline"></div><span class="go">8</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">byteorder</span>
<div class="newline"></div><span class="go">&#39;=&#39;</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="example-reading-wav-files">
<h4>Example: reading <code class="docutils literal notranslate"><span class="pre">.wav</span></code> files<a class="headerlink" href="#example-reading-wav-files" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">.wav</span></code> file header:</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="72%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>chunk_id</td>
<td><code class="docutils literal notranslate"><span class="pre">&quot;RIFF&quot;</span></code></td>
</tr>
<tr class="row-even"><td>chunk_size</td>
<td>4-byte unsigned little-endian integer</td>
</tr>
<tr class="row-odd"><td>format</td>
<td><code class="docutils literal notranslate"><span class="pre">&quot;WAVE&quot;</span></code></td>
</tr>
<tr class="row-even"><td>fmt_id</td>
<td><code class="docutils literal notranslate"><span class="pre">&quot;fmt</span> <span class="pre">&quot;</span></code></td>
</tr>
<tr class="row-odd"><td>fmt_size</td>
<td>4-byte unsigned little-endian integer</td>
</tr>
<tr class="row-even"><td>audio_fmt</td>
<td>2-byte unsigned little-endian integer</td>
</tr>
<tr class="row-odd"><td>num_channels</td>
<td>2-byte unsigned little-endian integer</td>
</tr>
<tr class="row-even"><td>sample_rate</td>
<td>4-byte unsigned little-endian integer</td>
</tr>
<tr class="row-odd"><td>byte_rate</td>
<td>4-byte unsigned little-endian integer</td>
</tr>
<tr class="row-even"><td>block_align</td>
<td>2-byte unsigned little-endian integer</td>
</tr>
<tr class="row-odd"><td>bits_per_sample</td>
<td>2-byte unsigned little-endian integer</td>
</tr>
<tr class="row-even"><td>data_id</td>
<td><code class="docutils literal notranslate"><span class="pre">&quot;data&quot;</span></code></td>
</tr>
<tr class="row-odd"><td>data_size</td>
<td>4-byte unsigned little-endian integer</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>44-byte block of raw data (in the beginning of the file)</li>
<li>… followed by <code class="docutils literal notranslate"><span class="pre">data_size</span></code> bytes of actual sound data.</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">.wav</span></code> file header as a NumPy <em>structured</em> data type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;chunk_id&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="c1"># flexible-sized scalar type, item size 4</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u4&quot;</span><span class="p">),</span>    <span class="c1"># little-endian unsigned 32-bit integer</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;S4&quot;</span><span class="p">),</span>         <span class="c1"># 4-byte string</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;fmt_id&quot;</span><span class="p">,</span> <span class="s2">&quot;S4&quot;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;fmt_size&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u4&quot;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;audio_fmt&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u2&quot;</span><span class="p">),</span>     <span class="c1">#</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;num_channels&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u2&quot;</span><span class="p">),</span>  <span class="c1"># .. more of the same ...</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;sample_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u4&quot;</span><span class="p">),</span>   <span class="c1">#</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;byte_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u4&quot;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;block_align&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u2&quot;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;bits_per_sample&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;u2&quot;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;data_id&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;S1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))),</span> <span class="c1"># sub-array, just for fun!</span>
<div class="newline"></div><span class="gp">... </span>    <span class="p">(</span><span class="s2">&quot;data_size&quot;</span><span class="p">,</span> <span class="s2">&quot;u4&quot;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>    <span class="c1">#</span>
<div class="newline"></div><span class="gp">... </span>    <span class="c1"># the sound data itself cannot be represented here:</span>
<div class="newline"></div><span class="gp">... </span>    <span class="c1"># it does not have a fixed size</span>
<div class="newline"></div><span class="gp">... </span>   <span class="p">])</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">wavreader.py</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header_dtype</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
<div class="newline"></div><span class="go">dtype(&#39;S4&#39;)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header_dtype</span><span class="o">.</span><span class="n">fields</span>     
<div class="newline"></div><span class="go">dict_proxy({&#39;block_align&#39;: (dtype(&#39;uint16&#39;), 32), &#39;format&#39;: (dtype(&#39;S4&#39;), 8), &#39;data_id&#39;: (dtype((&#39;S1&#39;, (2, 2))), 36), &#39;fmt_id&#39;: (dtype(&#39;S4&#39;), 12), &#39;byte_rate&#39;: (dtype(&#39;uint32&#39;), 28), &#39;chunk_id&#39;: (dtype(&#39;S4&#39;), 0), &#39;num_channels&#39;: (dtype(&#39;uint16&#39;), 22), &#39;sample_rate&#39;: (dtype(&#39;uint32&#39;), 24), &#39;bits_per_sample&#39;: (dtype(&#39;uint16&#39;), 34), &#39;chunk_size&#39;: (dtype(&#39;uint32&#39;), 4), &#39;fmt_size&#39;: (dtype(&#39;uint32&#39;), 16), &#39;data_size&#39;: (dtype(&#39;uint32&#39;), 40), &#39;audio_fmt&#39;: (dtype(&#39;uint16&#39;), 20)})</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header_dtype</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
<div class="newline"></div><span class="go">(dtype(&#39;S4&#39;), 8)</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>The first element is the sub-dtype in the structured data, corresponding
to the name <code class="docutils literal notranslate"><span class="pre">format</span></code></li>
<li>The second one is its offset (in bytes) from the beginning of the item</li>
</ul>
<div class="green topic">
<p class="topic-title">Exercise</p>
<p>Mini-exercise, make a “sparse” dtype by using offsets, and only some
of the fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
<div class="newline"></div><span class="gp">... </span>  <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;data_id&#39;</span><span class="p">],</span>
<div class="newline"></div><span class="gp">... </span>  <span class="n">offsets</span><span class="o">=</span><span class="p">[</span><span class="n">offset_1</span><span class="p">,</span> <span class="n">offset_2</span><span class="p">,</span> <span class="n">offset_3</span><span class="p">],</span> <span class="c1"># counted from start of structure in bytes</span>
<div class="newline"></div><span class="gp">... </span>  <span class="n">formats</span><span class="o">=</span><span class="nb">list</span> <span class="n">of</span> <span class="n">dtypes</span> <span class="k">for</span> <span class="n">each</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fields</span><span class="p">,</span>
<div class="newline"></div><span class="gp">... </span><span class="p">))</span>  
<div class="newline"></div></pre></div>
</div>
<p>and use that to read the sample rate, and <code class="docutils literal notranslate"><span class="pre">data_id</span></code> (as sub-array).</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/test.wav&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wav_header_dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">wav_header</span><span class="p">)</span>   
<div class="newline"></div><span class="go">[ (&#39;RIFF&#39;, 17402L, &#39;WAVE&#39;, &#39;fmt &#39;, 16L, 1, 1, 16000L, 32000L, 2, 16, [[&#39;d&#39;, &#39;a&#39;], [&#39;t&#39;, &#39;a&#39;]], 17366L)]</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header</span><span class="p">[</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">]</span>
<div class="newline"></div><span class="go">array([16000], dtype=uint32)</span>
<div class="newline"></div></pre></div>
</div>
<p>Let’s try accessing the sub-array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header</span><span class="p">[</span><span class="s1">&#39;data_id&#39;</span><span class="p">]</span>  
<div class="newline"></div><span class="go">array([[[&#39;d&#39;, &#39;a&#39;],</span>
<div class="newline"></div><span class="go">        [&#39;t&#39;, &#39;a&#39;]]],</span>
<div class="newline"></div><span class="go">      dtype=&#39;|S1&#39;)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header</span><span class="o">.</span><span class="n">shape</span>
<div class="newline"></div><span class="go">(1,)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">wav_header</span><span class="p">[</span><span class="s1">&#39;data_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<div class="newline"></div><span class="go">(1, 2, 2)</span>
<div class="newline"></div></pre></div>
</div>
<p>When accessing sub-arrays, the dimensions get added to the end!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are existing modules such as <code class="docutils literal notranslate"><span class="pre">wavfile</span></code>, <code class="docutils literal notranslate"><span class="pre">audiolab</span></code>,
etc. for loading sound data…</p>
</div>
</div>
<div class="section" id="casting-and-re-interpretation-views">
<h4>Casting and re-interpretation/views<a class="headerlink" href="#casting-and-re-interpretation-views" title="Permalink to this headline">¶</a></h4>
<p><strong>casting</strong></p>
<blockquote>
<div><ul class="simple">
<li>on assignment</li>
<li>on array construction</li>
<li>on arithmetic</li>
<li>etc.</li>
<li>and manually: <code class="docutils literal notranslate"><span class="pre">.astype(dtype)</span></code></li>
</ul>
</div></blockquote>
<p><strong>data re-interpretation</strong></p>
<blockquote>
<div><ul class="simple">
<li>manually: <code class="docutils literal notranslate"><span class="pre">.view(dtype)</span></code></li>
</ul>
</div></blockquote>
<div class="section" id="casting">
<h5>Casting<a class="headerlink" href="#casting" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first">Casting in arithmetic, in nutshell:</p>
<ul class="simple">
<li>only type (not value!) of operands matters</li>
<li>largest “safe” type able to represent both is picked</li>
<li>scalars can “lose” to arrays in some situations</li>
</ul>
</li>
<li><p class="first">Casting in general copies data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<div class="newline"></div><span class="go">array([1.,  2.,  3.,  4.])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([1, 2, 3, 4], dtype=int8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span>
<div class="newline"></div><span class="go">array([2, 3, 4, 5], dtype=int8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">+</span> <span class="mi">256</span>
<div class="newline"></div><span class="go">array([257, 258, 259, 260], dtype=int16)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">+</span> <span class="mf">256.0</span>
<div class="newline"></div><span class="go">array([257.,  258.,  259.,  260.])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">256</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<div class="newline"></div><span class="go">array([257, 258, 259, 260], dtype=int32)</span>
<div class="newline"></div></pre></div>
</div>
</li>
<li><p class="first">Casting on setitem: dtype of the array is not changed on item assignment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">1.5</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([2, 3, 4, 5], dtype=int8)</span>
<div class="newline"></div></pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Exact rules: see <a class="reference external" href="http://numpy.org/doc/stable/reference/ufuncs.html#casting-rules">numpy documentation</a></p>
</div>
</div>
<div class="section" id="re-interpretation-viewing">
<h5>Re-interpretation / viewing<a class="headerlink" href="#re-interpretation-viewing" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first">Data block in memory (4 bytes)</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="8%" />
<col width="19%" />
<col width="8%" />
<col width="19%" />
<col width="8%" />
<col width="19%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">0x01</span></code></td>
<td>||</td>
<td><code class="docutils literal notranslate"><span class="pre">0x02</span></code></td>
<td>||</td>
<td><code class="docutils literal notranslate"><span class="pre">0x03</span></code></td>
<td>||</td>
<td><code class="docutils literal notranslate"><span class="pre">0x04</span></code></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>4 of uint8, OR,</li>
<li>4 of int8, OR,</li>
<li>2 of int16, OR,</li>
<li>1 of int32, OR,</li>
<li>1 of float32, OR,</li>
<li>…</li>
</ul>
<p>How to switch from one to another?</p>
</li>
</ul>
<ol class="arabic">
<li><p class="first">Switch the dtype:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;&lt;i2&quot;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<div class="newline"></div><span class="go">array([ 513, 1027], dtype=int16)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="mh">0x0201</span><span class="p">,</span> <span class="mh">0x0403</span>
<div class="newline"></div><span class="go">(513, 1027)</span>
<div class="newline"></div></pre></div>
</div>
</li>
</ol>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="23%" />
<col width="9%" />
<col width="23%" />
<col width="23%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">0x01</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">0x02</span></code></td>
<td>||</td>
<td><code class="docutils literal notranslate"><span class="pre">0x03</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">0x04</span></code></td>
</tr>
</tbody>
</table>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">little-endian: least significant byte is on the <em>left</em> in memory</p>
</div>
</div></blockquote>
</div></blockquote>
<ol class="arabic" start="2">
<li><p class="first">Create a new view:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s2">&quot;&lt;i4&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([67305985], dtype=int32)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="mh">0x04030201</span>
<div class="newline"></div><span class="go">67305985</span>
<div class="newline"></div></pre></div>
</div>
</li>
</ol>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">0x01</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">0x02</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">0x03</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">0x04</span></code></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last">
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">.view()</span></code> makes <em>views</em>, does not copy (or alter) the memory block</p>
</li>
<li><p class="first">only changes the dtype (and adjusts array shape):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([328193], dtype=int32)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">x</span>
<div class="newline"></div><span class="go">True</span>
<div class="newline"></div></pre></div>
</div>
</li>
</ul>
</div>
<p class="rubric">Mini-exercise: data re-interpretation</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">view-colors.py</p>
</div>
<p>You have RGBA data in an array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<div class="newline"></div></pre></div>
</div>
<p>where the last three dimensions are the R, B, and G, and alpha channels.</p>
<p>How to make a (10, 10) structured array with field names ‘r’, ‘g’, ‘b’, ‘a’
without copying data?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="o">...</span>                     
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  
<div class="newline"></div></pre></div>
</div>
<p><em>Solution</em></p>
<blockquote>
<div><a onclick="$('#hidden-item-0').toggle(100)">...</a>
<div id="hidden-item-0" style="display: none;"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">([(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>            <span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>            <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">),</span>
<div class="newline"></div><span class="gp">... </span>            <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">)]</span>
<div class="newline"></div><span class="gp">... </span>             <span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
<div class="newline"></div></pre></div>
</div>
</div></div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Another array taking exactly 4 bytes of memory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<div class="newline"></div><span class="go">array([[1, 2],</span>
<div class="newline"></div><span class="go">       [3, 4]], dtype=uint8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([[1, 2],</span>
<div class="newline"></div><span class="go">       [3, 4]], dtype=uint8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="go">array([[ 513],</span>
<div class="newline"></div><span class="go">       [1027]], dtype=int16)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="mh">0x0201</span><span class="p">,</span> <span class="mh">0x0403</span>
<div class="newline"></div><span class="go">(513, 1027)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="go">array([[ 769, 1026]], dtype=int16)</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>What happened?</li>
<li>… we need to look into what <code class="docutils literal notranslate"><span class="pre">x[0,1]</span></code> actually means</li>
</ul>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mh">0x0301</span><span class="p">,</span> <span class="mh">0x0402</span>
<div class="newline"></div><span class="go">(769, 1026)</span>
<div class="newline"></div></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="indexing-scheme-strides">
<h3><a class="toc-backref" href="#id7">2.2.1.4. Indexing scheme: strides</a><a class="headerlink" href="#indexing-scheme-strides" title="Permalink to this headline">¶</a></h3>
<div class="section" id="main-point">
<h4>Main point<a class="headerlink" href="#main-point" title="Permalink to this headline">¶</a></h4>
<p><strong>The question</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<div class="newline"></div><span class="gp">... </span>              <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
<div class="newline"></div><span class="gp">... </span>              <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">b&#39;\x01\x02\x03\x04\x05\x06\x07\x08\t&#39;</span>
<div class="newline"></div>
<div class="newline"></div><span class="go">At which byte in ``x.data`` does the item ``x[1, 2]`` begin?</span>
<div class="newline"></div></pre></div>
</div>
<p><strong>The answer</strong> (in NumPy)</p>
<blockquote>
<div><ul class="simple">
<li><strong>strides</strong>: the number of bytes to jump to find the next element</li>
<li>1 stride per dimension</li>
</ul>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div>  <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<div class="newline"></div>  <span class="o">&gt;&gt;&gt;</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="mi">2</span>   <span class="c1"># to find x[1, 2]</span>
<div class="newline"></div>  <span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">byte_offset</span><span class="p">]</span>
<div class="newline"></div>  <span class="mi">6</span>
<div class="newline"></div>  <span class="o">&gt;&gt;&gt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<div class="newline"></div>  <span class="mi">6</span>
<div class="newline"></div>
<div class="newline"></div><span class="o">-</span> <span class="n">simple</span><span class="p">,</span> <span class="o">**</span><span class="n">flexible</span><span class="o">**</span>
<div class="newline"></div></pre></div>
</div>
<div class="section" id="c-and-fortran-order">
<h5>C and Fortran order<a class="headerlink" href="#c-and-fortran-order" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Python built-in <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#bytes" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> returns bytes in C-order by default
which can cause confusion when trying to inspect memory layout. We use
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.tobytes.html#numpy.ndarray.tobytes" title="(in NumPy v1.23)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">numpy.ndarray.tobytes()</span></code></a> with <code class="docutils literal notranslate"><span class="pre">order=A</span></code> instead, which preserves
the C or F ordering of the bytes in memory.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<div class="newline"></div><span class="gp">... </span>              <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(6, 2)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">b&#39;\x01\x00\x02\x00\x03\x00\x04\x00\x05\x00\x06\x00&#39;</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>Need to jump 6 bytes to find the next row</li>
<li>Need to jump 2 bytes to find the next column</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(2, 4)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">b&#39;\x01\x00\x04\x00\x02\x00\x05\x00\x03\x00\x06\x00&#39;</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>Need to jump 2 bytes to find the next row</li>
<li>Need to jump 4 bytes to find the next column</li>
</ul>
<ul>
<li><p class="first">Similarly to higher dimensions:</p>
<ul class="simple">
<li>C: last dimensions vary fastest (= smaller strides)</li>
<li>F: first dimensions vary fastest</li>
</ul>
<div class="math">
<p><img src="../../_images/math/225b2f8b68f83995c7478d095744145e65c42e71.png" alt="\mathrm{shape} &amp;= (d_1, d_2, ..., d_n)
\\
\mathrm{strides} &amp;= (s_1, s_2, ..., s_n)
\\
s_j^C &amp;= d_{j+1} d_{j+2} ... d_{n} \times \mathrm{itemsize}
\\
s_j^F &amp;= d_{1} d_{2} ... d_{j-1} \times \mathrm{itemsize}"/></p>
</div></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Now we can understand the behavior of <code class="docutils literal notranslate"><span class="pre">.view()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
<p>Transposition does not affect the memory layout of the data, only strides</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(2, 1)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(1, 2)</span>
<div class="newline"></div></pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">b&#39;\x01\x02\x03\x04&#39;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">b&#39;\x01\x03\x02\x04&#39;</span>
<div class="newline"></div></pre></div>
</div>
<ul class="last simple">
<li>the results are different when interpreted as 2 of int16</li>
<li><code class="docutils literal notranslate"><span class="pre">.copy()</span></code> creates new arrays in the C order (by default)</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>In-place operations with views</strong></p>
<p class="last">Prior to NumPy version 1.13, in-place operations with views could result in
<strong>incorrect</strong> results for large arrays.
Since <a class="reference external" href="https://numpy.org/doc/stable/release/1.13.0-notes.html" title="(in NumPy v1.23)"><span class="xref std std-doc">version 1.13</span></a>,
NumPy includes checks for <em>memory overlap</em> to
guarantee that results are consistent with the non in-place version
(e.g. <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">a.T</span></code> produces the same result as <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+=</span> <span class="pre">a.T</span></code>).
Note however that this may result in the data being copied (as if using
<code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+=</span> <span class="pre">a.T.copy()</span></code>), ultimately resulting in more memory being used than
might otherwise be expected for in-place operations!</p>
</div>
</div>
<div class="section" id="slicing-with-integers">
<h5>Slicing with integers<a class="headerlink" href="#slicing-with-integers" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><em>Everything</em> can be represented by changing only <code class="docutils literal notranslate"><span class="pre">shape</span></code>, <code class="docutils literal notranslate"><span class="pre">strides</span></code>,
and possibly adjusting the <code class="docutils literal notranslate"><span class="pre">data</span></code> pointer!</li>
<li>Never makes copies of the data</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([6, 5, 4, 3, 2, 1], dtype=int32)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(-4,)</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">__array_interface__</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<div class="newline"></div><span class="go">8</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(800, 80, 8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[::</span><span class="mi">2</span><span class="p">,::</span><span class="mi">3</span><span class="p">,::</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(1600, 240, 32)</span>
<div class="newline"></div></pre></div>
</div>
<ul>
<li><p class="first">Similarly, transposes never make copies (it just swaps strides):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(800, 80, 8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(8, 80, 800)</span>
<div class="newline"></div></pre></div>
</div>
</li>
</ul>
<p>But: not all reshaping operations can be represented by playing with
strides:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">(1, 2)</span>
<div class="newline"></div></pre></div>
</div>
<p>So far, so good. However:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">bytes</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<div class="newline"></div><span class="go">b&#39;\x00\x01\x02\x03\x04\x05&#39;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span>
<div class="newline"></div><span class="go">array([[0, 2, 4],</span>
<div class="newline"></div><span class="go">       [1, 3, 5]], dtype=int8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span>
<div class="newline"></div><span class="go">array([0, 2, 4, 1, 3, 5], dtype=int8)</span>
<div class="newline"></div></pre></div>
</div>
<p>Here, there is no way to represent the array <code class="docutils literal notranslate"><span class="pre">c</span></code> given one stride
and the block of memory for <code class="docutils literal notranslate"><span class="pre">a</span></code>. Therefore, the <code class="docutils literal notranslate"><span class="pre">reshape</span></code>
operation needs to make a copy here.</p>
</div>
</div>
<div class="section" id="example-fake-dimensions-with-strides">
<span id="stride-manipulation-label"></span><h4>Example: fake dimensions with strides<a class="headerlink" href="#example-fake-dimensions-with-strides" title="Permalink to this headline">¶</a></h4>
<p class="rubric">Stride manipulation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">numpy.lib.stride_tricks</span> <span class="kn">import</span> <span class="n">as_strided</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">as_strided</span><span class="p">)</span>    
<div class="newline"></div><span class="go">as_strided(x, shape=None, strides=None)</span>
<div class="newline"></div><span class="go">   Make an ndarray from the given array with the given shape and strides</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">as_strided</span></code> does <strong>not</strong> check that you stay inside the memory
block bounds…</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">))</span>
<div class="newline"></div><span class="go">array([1, 3], dtype=int16)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
<div class="newline"></div><span class="go">array([1, 3], dtype=int16)</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">stride-fakedims.py</p>
</div>
<p><strong>Exercise</strong></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="o">-&gt;</span> <span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
<div class="newline"></div>          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
<div class="newline"></div>          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>using only <code class="docutils literal notranslate"><span class="pre">as_strided</span></code>.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Hint</span><span class="p">:</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="n">stride</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">stride</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="o">...</span>
<div class="newline"></div></pre></div>
</div>
</div></blockquote>
<p><em>Spoiler</em></p>
<blockquote>
<div><a onclick="$('#hidden-item-1').toggle(100)">...</a>
<div id="hidden-item-1" style="display: none;"><p>Stride can also be <em>0</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([[1, 2, 3, 4],</span>
<div class="newline"></div><span class="go">       [1, 2, 3, 4],</span>
<div class="newline"></div><span class="go">       [1, 2, 3, 4]], dtype=int8)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">x</span>
<div class="newline"></div><span class="go">True</span>
<div class="newline"></div></pre></div>
</div>
</div></div></blockquote>
</div>
<div class="section" id="broadcasting">
<span id="broadcasting-advanced"></span><h4>Broadcasting<a class="headerlink" href="#broadcasting" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Doing something useful with it: outer product
of <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4]</span></code> and <code class="docutils literal notranslate"><span class="pre">[5,</span> <span class="pre">6,</span> <span class="pre">7]</span></code></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x2</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x2</span>
<div class="newline"></div><span class="go">array([[1, 2, 3, 4],</span>
<div class="newline"></div><span class="go">       [1, 2, 3, 4],</span>
<div class="newline"></div><span class="go">       [1, 2, 3, 4]], dtype=int16)</span>
<div class="newline"></div></pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y2</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y2</span>
<div class="newline"></div><span class="go">array([[5, 5, 5, 5],</span>
<div class="newline"></div><span class="go">       [6, 6, 6, 6],</span>
<div class="newline"></div><span class="go">       [7, 7, 7, 7]], dtype=int16)</span>
<div class="newline"></div></pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x2</span> <span class="o">*</span> <span class="n">y2</span>
<div class="newline"></div><span class="go">array([[ 5, 10, 15, 20],</span>
<div class="newline"></div><span class="go">       [ 6, 12, 18, 24],</span>
<div class="newline"></div><span class="go">       [ 7, 14, 21, 28]], dtype=int16)</span>
<div class="newline"></div></pre></div>
</div>
<p class="rubric">… seems somehow familiar …</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<div class="newline"></div><span class="go">array([[ 5, 10, 15, 20],</span>
<div class="newline"></div><span class="go">       [ 6, 12, 18, 24],</span>
<div class="newline"></div><span class="go">       [ 7, 14, 21, 28]], dtype=int16)</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>Internally, array <strong>broadcasting</strong> is indeed implemented using 0-strides.</li>
</ul>
</div>
<div class="section" id="more-tricks-diagonals">
<h4>More tricks: diagonals<a class="headerlink" href="#more-tricks-diagonals" title="Permalink to this headline">¶</a></h4>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">stride-diagonals.py</p>
</div>
<p><strong>Challenge</strong></p>
<blockquote>
<div><ul>
<li><p class="first">Pick diagonal entries of the matrix: (assume C memory order):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; x = np.array([[1, 2, 3],
<div class="newline"></div>...               [4, 5, 6],
<div class="newline"></div>...               [7, 8, 9]], dtype=np.int32)
<div class="newline"></div>
<div class="newline"></div>&gt;&gt;&gt; x_diag = as_strided(x, shape=(3,), strides=(???,)) 
<div class="newline"></div></pre></div>
</div>
</li>
<li><p class="first">Pick the first super-diagonal entries <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">6]</span></code>.</p>
</li>
<li><p class="first">And the sub-diagonals?</p>
</li>
</ul>
<dl class="docutils">
<dt>(Hint to the last two: slicing first moves the point where striding</dt>
<dd>starts from.)</dd>
</dl>
</div></blockquote>
<p><em>Solution</em></p>
<blockquote>
<div><a onclick="$('#hidden-item-2').toggle(100)">...</a>
<div id="hidden-item-2" style="display: none;"><p>Pick diagonals:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x_diag</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">((</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x_diag</span>
<div class="newline"></div><span class="go">array([1, 5, 9], dtype=int32)</span>
<div class="newline"></div></pre></div>
</div>
<p>Slice first, to adjust the data pointer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">((</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="p">))</span>
<div class="newline"></div><span class="go">array([2, 6], dtype=int32)</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">((</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="p">))</span>
<div class="newline"></div><span class="go">array([4, 8], dtype=int32)</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Using np.diag</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span>
<div class="newline"></div><span class="go">array([2, 6], dtype=int32)</span>
<div class="newline"></div></pre></div>
</div>
<p>However,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">owndata</span>  
<div class="newline"></div><span class="go">False</span>
<div class="newline"></div></pre></div>
</div>
<p class="last"><strong>Note</strong> This behavior has changed: before numpy 1.9, np.diag
would make a copy.</p>
</div>
</div></div></blockquote>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">stride-diagonals.py</p>
</div>
<p><strong>Challenge</strong></p>
<blockquote>
<div><p>Compute the tensor trace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="n">s</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
<div class="newline"></div></pre></div>
</div>
<p>by striding, and using <code class="docutils literal notranslate"><span class="pre">sum()</span></code> on the result.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">TODO</span><span class="p">,</span> <span class="n">TODO</span><span class="p">))</span>   
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="o">...</span>   
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s2</span>   
<div class="newline"></div></pre></div>
</div>
</div></blockquote>
<p><em>Solution</em></p>
<blockquote>
<div><a onclick="$('#hidden-item-2-2').toggle(100)">...</a>
<div id="hidden-item-2-2" style="display: none;"><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">as_strided</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">((</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>
<div class="newline"></div><span class="gp">... </span>                                         <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">itemsize</span><span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
</div></div></blockquote>
</div>
<div class="section" id="cpu-cache-effects">
<span id="cache-effects"></span><h4>CPU cache effects<a class="headerlink" href="#cpu-cache-effects" title="Permalink to this headline">¶</a></h4>
<p>Memory layout can affect performance:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">20000</span><span class="p">,))</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">In [2]: </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">20000</span><span class="o">*</span><span class="mi">67</span><span class="p">,))[::</span><span class="mi">67</span><span class="p">]</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">In [3]: </span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
<div class="newline"></div><span class="go">((20000,), (20000,))</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">In [4]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<div class="newline"></div><span class="go">100000 loops, best of 3: 0.180 ms per loop</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">In [5]: </span><span class="o">%</span><span class="n">timeit</span> <span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<div class="newline"></div><span class="go">100000 loops, best of 3: 2.34 ms per loop</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">In [6]: </span><span class="n">x</span><span class="o">.</span><span class="n">strides</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">strides</span>
<div class="newline"></div><span class="go">((8,), (536,))</span>
<div class="newline"></div></pre></div>
</div>
<p class="rubric">Smaller strides are faster?</p>
<img alt="../../_images/cpu-cacheline.png" src="../../_images/cpu-cacheline.png" />
<ul class="simple">
<li>CPU pulls data from main memory to its cache in blocks</li>
<li>If many array items consecutively operated on fit in a single block (small stride):<ul>
<li><img class="math" src="../../_images/math/97e58c1e7a742a4105ca9408b7e8a9bf45658360.png" alt="\Rightarrow"/> fewer transfers needed</li>
<li><img class="math" src="../../_images/math/97e58c1e7a742a4105ca9408b7e8a9bf45658360.png" alt="\Rightarrow"/> faster</li>
</ul>
</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference external" href="https://numexpr.readthedocs.io">numexpr</a> is designed to mitigate
cache effects when evaluating array expressions.</li>
<li><a class="reference external" href="https://numba.pydata.org/">numba</a> is a compiler for Python code,
that is aware of numpy arrays.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="findings-in-dissection">
<h3><a class="toc-backref" href="#id8">2.2.1.5. Findings in dissection</a><a class="headerlink" href="#findings-in-dissection" title="Permalink to this headline">¶</a></h3>
<img alt="../../_images/threefundamental.png" src="../../_images/threefundamental.png" />
<ul class="simple">
<li><em>memory block</em>: may be shared, <code class="docutils literal notranslate"><span class="pre">.base</span></code>, <code class="docutils literal notranslate"><span class="pre">.data</span></code></li>
<li><em>data type descriptor</em>: structured data, sub-arrays, byte order,
casting, viewing, <code class="docutils literal notranslate"><span class="pre">.astype()</span></code>, <code class="docutils literal notranslate"><span class="pre">.view()</span></code></li>
<li><em>strided indexing</em>: strides, C/F-order, slicing w/ integers,
<code class="docutils literal notranslate"><span class="pre">as_strided</span></code>, broadcasting, stride tricks, <code class="docutils literal notranslate"><span class="pre">diag</span></code>, CPU cache
coherence</li>
</ul>
</div>
</div>
<div class="section" id="universal-functions">
<h2><a class="toc-backref" href="#id9">2.2.2. Universal functions</a><a class="headerlink" href="#universal-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-they-are">
<h3><a class="toc-backref" href="#id10">2.2.2.1. What they are?</a><a class="headerlink" href="#what-they-are" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Ufunc performs and elementwise operation on all elements of an array.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.*</span><span class="p">,</span> <span class="o">...</span>
<div class="newline"></div></pre></div>
</div>
</li>
<li><p class="first">Automatically support: broadcasting, casting, …</p>
</li>
<li><p class="first">The author of an ufunc only has to supply the elementwise operation,
NumPy takes care of the rest.</p>
</li>
<li><p class="first">The elementwise operation needs to be implemented in C (or, e.g., Cython)</p>
</li>
</ul>
<div class="section" id="parts-of-an-ufunc">
<h4>Parts of an Ufunc<a class="headerlink" href="#parts-of-an-ufunc" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Provided by user</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">ufunc_loop</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<div class="newline"></div><span class="p">{</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="cm">/*</span>
<div class="newline"></div><span class="cm">     * int8 output = elementwise_function(int8 input_1, int8 input_2)</span>
<div class="newline"></div><span class="cm">     *</span>
<div class="newline"></div><span class="cm">     * This function must compute the ufunc for many values at once,</span>
<div class="newline"></div><span class="cm">     * in the way shown below.</span>
<div class="newline"></div><span class="cm">     */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="o">*</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elementwise_function</span><span class="p">(</span><span class="o">*</span><span class="n">input_1</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">input_2</span><span class="p">);</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">input_1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">input_2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="p">}</span><span class="w"></span>
<div class="newline"></div><span class="p">}</span><span class="w"></span>
<div class="newline"></div></pre></div>
</div>
</li>
<li><p class="first">The NumPy part, built by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NPY_BYTE</span><span class="w">   </span><span class="cm">/* type of first input arg */</span><span class="w"></span>
<div class="newline"></div><span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NPY_BYTE</span><span class="w">   </span><span class="cm">/* type of second input arg */</span><span class="w"></span>
<div class="newline"></div><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NPY_BYTE</span><span class="w">   </span><span class="cm">/* type of third input arg */</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">python_ufunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="n">ufunc_loop</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="n">types</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cm">/* ntypes */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="cm">/* num_inputs */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="cm">/* num_outputs */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="n">identity_element</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="n">docstring</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="n">unused</span><span class="p">)</span><span class="w"></span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>A ufunc can also support multiple different input-output type
combinations.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="making-it-easier">
<h4>Making it easier<a class="headerlink" href="#making-it-easier" title="Permalink to this headline">¶</a></h4>
<ol class="arabic" start="3">
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">ufunc_loop</span></code> is of very generic form, and NumPy provides
pre-made ones</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_f_f</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">float</span> <span class="pre">elementwise_func(float</span> <span class="pre">input_1)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_ff_f</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">float</span> <span class="pre">elementwise_func(float</span> <span class="pre">input_1,</span> <span class="pre">float</span> <span class="pre">input_2)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_d_d</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">elementwise_func(double</span> <span class="pre">input_1)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_dd_d</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">elementwise_func(double</span> <span class="pre">input_1,</span> <span class="pre">double</span> <span class="pre">input_2)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_D_D</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">elementwise_func(npy_cdouble</span> <span class="pre">*input,</span> <span class="pre">npy_cdouble*</span> <span class="pre">output)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_DD_D</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">elementwise_func(npy_cdouble</span> <span class="pre">*in1,</span> <span class="pre">npy_cdouble</span> <span class="pre">*in2,</span> <span class="pre">npy_cdouble*</span> <span class="pre">out)</span></code></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Only <code class="docutils literal notranslate"><span class="pre">elementwise_func</span></code> needs to be supplied</li>
<li>… except when your elementwise function is not in one of the above forms</li>
</ul>
</li>
</ol>
</div>
</div>
<div class="section" id="exercise-building-an-ufunc-from-scratch">
<h3><a class="toc-backref" href="#id11">2.2.2.2. Exercise: building an ufunc from scratch</a><a class="headerlink" href="#exercise-building-an-ufunc-from-scratch" title="Permalink to this headline">¶</a></h3>
<p>The Mandelbrot fractal is defined by the iteration</p>
<div class="math">
<p><img src="../../_images/math/f5bbd55c704788a708db0c51577d9bbe2c0473b0.png" alt="z \leftarrow z^2 + c"/></p>
</div><p>where <img class="math" src="../../_images/math/6065ef854df8ec4527976efe49d0e1454b1f2fd7.png" alt="c = x + i y"/> is a complex number. This iteration is
repeated – if <img class="math" src="../../_images/math/683f2dd9129a91d21aaf1c04afa6f78b39d4cb0a.png" alt="z"/> stays finite no matter how long the iteration
runs, <img class="math" src="../../_images/math/ae12a24f88803b5895632e4848d87d46483c492c.png" alt="c"/> belongs to the Mandelbrot set.</p>
<ul>
<li><p class="first">Make ufunc called <code class="docutils literal notranslate"><span class="pre">mandel(z0,</span> <span class="pre">c)</span></code> that computes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">z</span> <span class="o">=</span> <span class="n">z0</span>
<div class="newline"></div><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
<div class="newline"></div>    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">c</span>
<div class="newline"></div></pre></div>
</div>
<p>say, 100 iterations or until <code class="docutils literal notranslate"><span class="pre">z.real**2</span> <span class="pre">+</span> <span class="pre">z.imag**2</span> <span class="pre">&gt;</span> <span class="pre">1000</span></code>.
Use it to determine which <cite>c</cite> are in the Mandelbrot set.</p>
</li>
<li><p class="first">Our function is a simple one, so make use of the <code class="docutils literal notranslate"><span class="pre">PyUFunc_*</span></code> helpers.</p>
</li>
<li><p class="first">Write it in Cython</p>
</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">mandel.pyx, mandelplot.py</p>
</div>
<p>Reminder: some pre-made Ufunc loops:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_f_f</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">float</span> <span class="pre">elementwise_func(float</span> <span class="pre">input_1)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_ff_f</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">float</span> <span class="pre">elementwise_func(float</span> <span class="pre">input_1,</span> <span class="pre">float</span> <span class="pre">input_2)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_d_d</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">elementwise_func(double</span> <span class="pre">input_1)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_dd_d</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">elementwise_func(double</span> <span class="pre">input_1,</span> <span class="pre">double</span> <span class="pre">input_2)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_D_D</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">elementwise_func(complex_double</span> <span class="pre">*input,</span> <span class="pre">complex_double*</span> <span class="pre">output)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">PyUfunc_DD_D</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">elementwise_func(complex_double</span> <span class="pre">*in1,</span> <span class="pre">complex_double</span> <span class="pre">*in2,</span> <span class="pre">complex_double*</span> <span class="pre">out)</span></code></td>
</tr>
</tbody>
</table>
<p>Type codes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NPY_BOOL</span><span class="p">,</span> <span class="n">NPY_BYTE</span><span class="p">,</span> <span class="n">NPY_UBYTE</span><span class="p">,</span> <span class="n">NPY_SHORT</span><span class="p">,</span> <span class="n">NPY_USHORT</span><span class="p">,</span> <span class="n">NPY_INT</span><span class="p">,</span> <span class="n">NPY_UINT</span><span class="p">,</span>
<div class="newline"></div><span class="n">NPY_LONG</span><span class="p">,</span> <span class="n">NPY_ULONG</span><span class="p">,</span> <span class="n">NPY_LONGLONG</span><span class="p">,</span> <span class="n">NPY_ULONGLONG</span><span class="p">,</span> <span class="n">NPY_FLOAT</span><span class="p">,</span> <span class="n">NPY_DOUBLE</span><span class="p">,</span>
<div class="newline"></div><span class="n">NPY_LONGDOUBLE</span><span class="p">,</span> <span class="n">NPY_CFLOAT</span><span class="p">,</span> <span class="n">NPY_CDOUBLE</span><span class="p">,</span> <span class="n">NPY_CLONGDOUBLE</span><span class="p">,</span> <span class="n">NPY_DATETIME</span><span class="p">,</span>
<div class="newline"></div><span class="n">NPY_TIMEDELTA</span><span class="p">,</span> <span class="n">NPY_OBJECT</span><span class="p">,</span> <span class="n">NPY_STRING</span><span class="p">,</span> <span class="n">NPY_UNICODE</span><span class="p">,</span> <span class="n">NPY_VOID</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="solution-building-an-ufunc-from-scratch">
<h3><a class="toc-backref" href="#id12">2.2.2.3. Solution: building an ufunc from scratch</a><a class="headerlink" href="#solution-building-an-ufunc-from-scratch" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The elementwise function</span>
<div class="newline"></div><span class="c1"># ------------------------</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">cdef</span> <span class="n">void</span> <span class="n">mandel_single_point</span><span class="p">(</span><span class="n">double</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">z_in</span><span class="p">,</span> 
<div class="newline"></div>                              <span class="n">double</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">c_in</span><span class="p">,</span>
<div class="newline"></div>                              <span class="n">double</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">z_out</span><span class="p">)</span> <span class="n">nogil</span><span class="p">:</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>    <span class="c1"># The Mandelbrot iteration</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>    <span class="c1"># Some points of note:</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>    <span class="c1"># - It&#39;s *NOT* allowed to call any Python functions here.</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>    <span class="c1">#   The Ufunc loop runs with the Python Global Interpreter Lock released.</span>
<div class="newline"></div>    <span class="c1">#   Hence, the ``nogil``.</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>    <span class="c1"># - And so all local variables must be declared with ``cdef``</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>    <span class="c1"># - Note also that this function receives *pointers* to the data;</span>
<div class="newline"></div>    <span class="c1">#   the &quot;traditional&quot; solution to passing complex variables around</span>
<div class="newline"></div>    <span class="c1">#</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="n">cdef</span> <span class="n">double</span> <span class="nb">complex</span> <span class="n">z</span> <span class="o">=</span> <span class="n">z_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<div class="newline"></div>    <span class="n">cdef</span> <span class="n">double</span> <span class="nb">complex</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<div class="newline"></div>    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">k</span>  <span class="c1"># the integer we use in the for loop</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="c1"># Straightforward iteration</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
<div class="newline"></div>        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">c</span>
<div class="newline"></div>        <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
<div class="newline"></div>            <span class="k">break</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="c1"># Return the answer for this point</span>
<div class="newline"></div>    <span class="n">z_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
<div class="newline"></div>
<div class="newline"></div>
<div class="newline"></div><span class="c1"># Boilerplate Cython definitions</span>
<div class="newline"></div><span class="c1">#</span>
<div class="newline"></div><span class="c1"># Pulls definitions from the Numpy C headers.</span>
<div class="newline"></div><span class="c1"># -------------------------------------------</span>
<div class="newline"></div>
<div class="newline"></div><span class="kn">from</span> <span class="nn">numpy</span> <span class="n">cimport</span> <span class="n">import_array</span><span class="p">,</span> <span class="n">import_ufunc</span> 
<div class="newline"></div><span class="kn">from</span> <span class="nn">numpy</span> <span class="n">cimport</span> <span class="p">(</span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">,</span>
<div class="newline"></div>                    <span class="n">PyUFuncGenericFunction</span><span class="p">)</span>
<div class="newline"></div><span class="kn">from</span> <span class="nn">numpy</span> <span class="n">cimport</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div><span class="kn">from</span> <span class="nn">numpy</span> <span class="n">cimport</span> <span class="n">PyUFunc_DD_D</span>
<div class="newline"></div>
<div class="newline"></div><span class="c1"># Required module initialization</span>
<div class="newline"></div><span class="c1"># ------------------------------</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">import_array</span><span class="p">()</span>
<div class="newline"></div><span class="n">import_ufunc</span><span class="p">()</span>
<div class="newline"></div>
<div class="newline"></div>
<div class="newline"></div><span class="c1"># The actual ufunc declaration</span>
<div class="newline"></div><span class="c1"># ----------------------------</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">cdef</span> <span class="n">PyUFuncGenericFunction</span> <span class="n">loop_func</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<div class="newline"></div><span class="n">cdef</span> <span class="n">char</span> <span class="n">input_output_types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<div class="newline"></div><span class="n">cdef</span> <span class="n">void</span> <span class="o">*</span><span class="n">elementwise_funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">loop_func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PyUFunc_DD_D</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">elementwise_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">mandel_single_point</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">mandel</span> <span class="o">=</span> <span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span>
<div class="newline"></div>    <span class="n">loop_func</span><span class="p">,</span>
<div class="newline"></div>    <span class="n">elementwise_funcs</span><span class="p">,</span>
<div class="newline"></div>    <span class="n">input_output_types</span><span class="p">,</span>
<div class="newline"></div>    <span class="mi">1</span><span class="p">,</span> <span class="c1"># number of supported input types</span>
<div class="newline"></div>    <span class="mi">2</span><span class="p">,</span> <span class="c1"># number of input args</span>
<div class="newline"></div>    <span class="mi">1</span><span class="p">,</span> <span class="c1"># number of output args</span>
<div class="newline"></div>    <span class="mi">0</span><span class="p">,</span> <span class="c1"># `identity` element, never mind this</span>
<div class="newline"></div>    <span class="s2">&quot;mandel&quot;</span><span class="p">,</span> <span class="c1"># function name</span>
<div class="newline"></div>    <span class="s2">&quot;mandel(z, c) -&gt; computes iterated z*z + c&quot;</span><span class="p">,</span> <span class="c1"># docstring</span>
<div class="newline"></div>    <span class="mi">0</span> <span class="c1"># unused</span>
<div class="newline"></div>    <span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<div class="newline"></div><span class="sd">Plot Mandelbrot</span>
<div class="newline"></div><span class="sd">================</span>
<div class="newline"></div>
<div class="newline"></div><span class="sd">Plot the Mandelbrot ensemble.</span>
<div class="newline"></div>
<div class="newline"></div><span class="sd">&quot;&quot;&quot;</span>
<div class="newline"></div>
<div class="newline"></div><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<div class="newline"></div><span class="kn">import</span> <span class="nn">mandel</span>
<div class="newline"></div><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<div class="newline"></div><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<div class="newline"></div><span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">y</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
<div class="newline"></div><span class="n">z</span> <span class="o">=</span> <span class="n">mandel</span><span class="o">.</span><span class="n">mandel</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<div class="newline"></div><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">])</span>
<div class="newline"></div><span class="n">plt</span><span class="o">.</span><span class="n">gray</span><span class="p">()</span>
<div class="newline"></div><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
<img alt="../../_images/mandelbrot.png" src="../../_images/mandelbrot.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Most of the boilerplate could be automated by these Cython modules:</p>
<p class="last"><a class="reference external" href="https://github.com/cython/cython/wiki/MarkLodato-CreatingUfuncs">https://github.com/cython/cython/wiki/MarkLodato-CreatingUfuncs</a></p>
</div>
<p class="rubric">Several accepted input types</p>
<p>E.g. supporting both single- and double-precision versions</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span> <span class="kt">void</span> <span class="nf">mandel_single_point</span><span class="p">(</span><span class="n">double</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">z_in</span><span class="p">,</span>
<div class="newline"></div>                              <span class="n">double</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">c_in</span><span class="p">,</span>
<div class="newline"></div>                              <span class="n">double</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">z_out</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
<div class="newline"></div>   <span class="o">...</span>
<div class="newline"></div>
<div class="newline"></div><span class="k">cdef</span> <span class="kt">void</span> <span class="nf">mandel_single_point_singleprec</span><span class="p">(</span><span class="nb">float</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">z_in</span><span class="p">,</span>
<div class="newline"></div>                                         <span class="nb">float</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">c_in</span><span class="p">,</span>
<div class="newline"></div>                                         <span class="nb">float</span> <span class="nb">complex</span> <span class="o">*</span><span class="n">z_out</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
<div class="newline"></div>   <span class="o">...</span>
<div class="newline"></div>
<div class="newline"></div><span class="k">cdef</span> <span class="kt">PyUFuncGenericFunction</span> <span class="kt">loop_funcs</span>[2]
<div class="newline"></div><span class="k">cdef</span> <span class="kt">char</span> <span class="kt">input_output_types</span>[3*2]
<div class="newline"></div><span class="k">cdef</span> <span class="kt">void</span> *<span class="kt">elementwise_funcs</span>[1*2]
<div class="newline"></div>
<div class="newline"></div><span class="n">loop_funcs</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PyUFunc_DD_D</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CDOUBLE</span>
<div class="newline"></div><span class="n">elementwise_funcs</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">mandel_single_point</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">loop_funcs</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PyUFunc_FF_F</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CFLOAT</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mf">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CFLOAT</span>
<div class="newline"></div><span class="n">input_output_types</span><span class="p">[</span><span class="mf">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">NPY_CFLOAT</span>
<div class="newline"></div><span class="n">elementwise_funcs</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">mandel_single_point_singleprec</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">mandel</span> <span class="o">=</span> <span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span>
<div class="newline"></div>    <span class="n">loop_func</span><span class="p">,</span>
<div class="newline"></div>    <span class="n">elementwise_funcs</span><span class="p">,</span>
<div class="newline"></div>    <span class="n">input_output_types</span><span class="p">,</span>
<div class="newline"></div>    <span class="mf">2</span><span class="p">,</span> <span class="c"># number of supported input types   &lt;----------------</span>
<div class="newline"></div>    <span class="mf">2</span><span class="p">,</span> <span class="c"># number of input args</span>
<div class="newline"></div>    <span class="mf">1</span><span class="p">,</span> <span class="c"># number of output args</span>
<div class="newline"></div>    <span class="mf">0</span><span class="p">,</span> <span class="c"># `identity` element, never mind this</span>
<div class="newline"></div>    <span class="s">&quot;mandel&quot;</span><span class="p">,</span> <span class="c"># function name</span>
<div class="newline"></div>    <span class="s">&quot;mandel(z, c) -&gt; computes iterated z*z + c&quot;</span><span class="p">,</span> <span class="c"># docstring</span>
<div class="newline"></div>    <span class="mf">0</span> <span class="c"># unused</span>
<div class="newline"></div>    <span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="generalized-ufuncs">
<h3><a class="toc-backref" href="#id13">2.2.2.4. Generalized ufuncs</a><a class="headerlink" href="#generalized-ufuncs" title="Permalink to this headline">¶</a></h3>
<p><strong>ufunc</strong></p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">=</span> <span class="pre">elementwise_function(input)</span></code></p>
<p>Both <code class="docutils literal notranslate"><span class="pre">output</span></code> and <code class="docutils literal notranslate"><span class="pre">input</span></code> can be a single array element only.</p>
</div></blockquote>
<p><strong>generalized ufunc</strong></p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">output</span></code> and <code class="docutils literal notranslate"><span class="pre">input</span></code> can be arrays with a fixed number of dimensions</p>
<p>For example, matrix trace (sum of diag elements):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<div class="newline"></div><span class="n">output</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>      <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span>  <span class="n">scalar</span>
<div class="newline"></div>
<div class="newline"></div><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
<p>Matrix product:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">input_1</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<div class="newline"></div><span class="n">input_2</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<div class="newline"></div><span class="n">output</span> <span class="n">shape</span>  <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>This is called the <em>“signature”</em> of the generalized ufunc</li>
<li>The dimensions on which the g-ufunc acts, are <em>“core dimensions”</em></li>
</ul>
</div></blockquote>
<p class="rubric">Status in NumPy</p>
<ul>
<li><p class="first">g-ufuncs are in NumPy already …</p>
</li>
<li><p class="first">new ones can be created with <code class="docutils literal notranslate"><span class="pre">PyUFunc_FromFuncAndDataAndSignature</span></code></p>
</li>
<li><p class="first">most linear-algebra functions are implemented as g-ufuncs to enable working
with stacked arrays:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<div class="newline"></div><span class="go">array([ 0.00965823, -0.13344729,  0.04583961])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">_umath_linalg</span><span class="o">.</span><span class="n">det</span><span class="o">.</span><span class="n">signature</span>
<div class="newline"></div><span class="go">&#39;(m,m)-&gt;()&#39;</span>
<div class="newline"></div></pre></div>
</div>
</li>
<li><p class="first">we also ship with a few g-ufuncs for testing, ATM:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy.core.umath_tests</span> <span class="k">as</span> <span class="nn">ut</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">ut</span><span class="o">.</span><span class="n">matrix_multiply</span><span class="o">.</span><span class="n">signature</span>
<div class="newline"></div><span class="go">&#39;(m,n),(n,p)-&gt;(m,p)&#39;</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">ut</span><span class="o">.</span><span class="n">matrix_multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
<div class="newline"></div><span class="go">(10, 2, 5)</span>
<div class="newline"></div></pre></div>
</div>
</li>
<li><p class="first">in both examples the last two dimensions became <em>core dimensions</em>,
and are modified as per the <em>signature</em></p>
</li>
<li><p class="first">otherwise, the g-ufunc operates “elementwise”</p>
</li>
<li><p class="first">matrix multiplication this way could be useful for operating on
many small matrices at once</p>
</li>
</ul>
<p class="rubric">Generalized ufunc loop</p>
<p>Matrix multiplication <code class="docutils literal notranslate"><span class="pre">(m,n),(n,p)</span> <span class="pre">-&gt;</span> <span class="pre">(m,p)</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">gufunc_loop</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<div class="newline"></div><span class="p">{</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="cm">/* these are as previously */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">input_1_stride_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w">  </span><span class="cm">/* strides for the core dimensions */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">input_1_stride_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w">  </span><span class="cm">/* are added after the non-core */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">input_2_strides_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="w"> </span><span class="cm">/* steps */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">input_2_strides_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">output_strides_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">output_strides_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimension</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="cm">/* core dimensions are added after */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimension</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"> </span><span class="cm">/* the main dimension; order as in */</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimension</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"> </span><span class="cm">/* signature */</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">matmul_for_strided_matrices</span><span class="p">(</span><span class="n">input_1</span><span class="p">,</span><span class="w"> </span><span class="n">input_2</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"></span>
<div class="newline"></div><span class="w">                                    </span><span class="n">strides</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="n">array</span><span class="p">...);</span><span class="w"></span>
<div class="newline"></div>
<div class="newline"></div><span class="w">        </span><span class="n">input_1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">input_2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">        </span><span class="n">output</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<div class="newline"></div><span class="w">    </span><span class="p">}</span><span class="w"></span>
<div class="newline"></div><span class="p">}</span><span class="w"></span>
<div class="newline"></div></pre></div>
</div>
</div>
</div>
<div class="section" id="interoperability-features">
<h2><a class="toc-backref" href="#id14">2.2.3. Interoperability features</a><a class="headerlink" href="#interoperability-features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sharing-multidimensional-typed-data">
<h3><a class="toc-backref" href="#id15">2.2.3.1. Sharing multidimensional, typed data</a><a class="headerlink" href="#sharing-multidimensional-typed-data" title="Permalink to this headline">¶</a></h3>
<p>Suppose you</p>
<ol class="arabic simple">
<li>Write a library than handles (multidimensional) binary data,</li>
<li>Want to make it easy to manipulate the data with NumPy, or whatever
other library,</li>
<li>… but would <strong>not</strong> like to have NumPy as a dependency.</li>
</ol>
<p>Currently, 3 solutions:</p>
<ol class="arabic simple">
<li>the “old” buffer interface</li>
<li>the array interface</li>
<li>the “new” buffer interface (<span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-3118"><strong>PEP 3118</strong></a>)</li>
</ol>
</div>
<div class="section" id="the-old-buffer-protocol">
<h3><a class="toc-backref" href="#id16">2.2.3.2. The old buffer protocol</a><a class="headerlink" href="#the-old-buffer-protocol" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Only 1-D buffers</li>
<li>No data type information</li>
<li>C-level interface; <code class="docutils literal notranslate"><span class="pre">PyBufferProcs</span> <span class="pre">tp_as_buffer</span></code> in the type object</li>
<li>But it’s integrated into Python  (e.g. strings support it)</li>
</ul>
<p>Mini-exercise using <a class="reference external" href="https://python-pillow.github.io/">Pillow</a> (Python
Imaging Library):</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">pilbuffer.py</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span> <span class="c1"># Red</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="c1"># In PIL, RGBA images consist of 32-bit integers whose bytes are [RR,GG,BB,AA]</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;test.png&#39;</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p><strong>Q:</strong></p>
<blockquote>
<div>Check what happens if <code class="docutils literal notranslate"><span class="pre">data</span></code> is now modified, and <code class="docutils literal notranslate"><span class="pre">img</span></code> saved again.</div></blockquote>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id17">2.2.3.3. The old buffer protocol</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<div class="newline"></div><span class="sd">From buffer</span>
<div class="newline"></div><span class="sd">============</span>
<div class="newline"></div>
<div class="newline"></div><span class="sd">Show how to exchange data between numpy and a library that only knows</span>
<div class="newline"></div><span class="sd">the buffer interface.</span>
<div class="newline"></div><span class="sd">&quot;&quot;&quot;</span>
<div class="newline"></div>
<div class="newline"></div><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<div class="newline"></div><span class="kn">import</span> <span class="nn">Image</span>
<div class="newline"></div>
<div class="newline"></div><span class="c1"># Let&#39;s make a sample image, RGBA format</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">x</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">254</span> <span class="c1"># red</span>
<div class="newline"></div><span class="n">x</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="c1"># opaque</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">data</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="c1"># Check that you understand why this is OK!</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<div class="newline"></div><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;test.png&#39;</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="c1">#</span>
<div class="newline"></div><span class="c1"># Modify the original data, and save again.</span>
<div class="newline"></div><span class="c1">#</span>
<div class="newline"></div><span class="c1"># It turns out that PIL, which knows next to nothing about Numpy,</span>
<div class="newline"></div><span class="c1"># happily shares the same data.</span>
<div class="newline"></div><span class="c1">#</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">x</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">254</span>
<div class="newline"></div><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;test2.png&#39;</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<img alt="../../_images/test.png" src="../../_images/test.png" />
<img alt="../../_images/test2.png" src="../../_images/test2.png" />
</div>
<div class="section" id="array-interface-protocol">
<h3><a class="toc-backref" href="#id18">2.2.3.4. Array interface protocol</a><a class="headerlink" href="#array-interface-protocol" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Multidimensional buffers</li>
<li>Data type information present</li>
<li>NumPy-specific approach; slowly deprecated (but not going away)</li>
<li>Not integrated in Python otherwise</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Documentation:
<a class="reference external" href="http://numpy.org/doc/stable/reference/arrays.interface.html">http://numpy.org/doc/stable/reference/arrays.interface.html</a></p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">__array_interface__</span>   
<div class="newline"></div><span class="go">{&#39;data&#39;: (171694552, False),      # memory address of data, is readonly?</span>
<div class="newline"></div><span class="go"> &#39;descr&#39;: [(&#39;&#39;, &#39;&lt;i4&#39;)],          # data type descriptor</span>
<div class="newline"></div><span class="go"> &#39;typestr&#39;: &#39;&lt;i4&#39;,                # same, in another form</span>
<div class="newline"></div><span class="go"> &#39;strides&#39;: None,                 # strides; or None if in C-order</span>
<div class="newline"></div><span class="go"> &#39;shape&#39;: (2, 2),</span>
<div class="newline"></div><span class="go"> &#39;version&#39;: 3,</span>
<div class="newline"></div><span class="go">}</span>
<div class="newline"></div></pre></div>
</div>
<dl class="docutils">
<dt>::</dt>
<dd><div class="first last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/test.png&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">img</span><span class="o">.</span><span class="n">__array_interface__</span>     
<div class="newline"></div><span class="go">{&#39;data&#39;: ...,</span>
<div class="newline"></div><span class="go"> &#39;shape&#39;: (200, 200, 4),</span>
<div class="newline"></div><span class="go"> &#39;typestr&#39;: &#39;|u1&#39;}</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<div class="newline"></div><span class="go">(200, 200, 4)</span>
<div class="newline"></div></pre></div>
</div>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A more C-friendly variant of the array interface is also defined.</p>
</div>
</div>
</div>
<div class="section" id="array-siblings-chararray-maskedarray-matrix">
<span id="array-siblings"></span><h2><a class="toc-backref" href="#id19">2.2.4. Array siblings: <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.chararray.html#numpy.chararray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">chararray</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">maskedarray</span></code>, <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.matrix.html#numpy.matrix" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">matrix</span></code></a></a><a class="headerlink" href="#array-siblings-chararray-maskedarray-matrix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="chararray-vectorized-string-operations">
<h3><a class="toc-backref" href="#id20">2.2.4.1. <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.chararray.html#numpy.chararray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">chararray</span></code></a>: vectorized string operations</a><a class="headerlink" href="#chararray-vectorized-string-operations" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;  bbb&#39;</span><span class="p">,</span> <span class="s1">&#39;  ccc&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">chararray</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>       
<div class="newline"></div><span class="go">chararray([&#39;a&#39;, &#39;bbb&#39;, &#39;ccc&#39;],</span>
<div class="newline"></div><span class="go">      dtype=&#39;...&#39;)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>       
<div class="newline"></div><span class="go">chararray([&#39;A&#39;, &#39;  BBB&#39;, &#39;  CCC&#39;],</span>
<div class="newline"></div><span class="go">      dtype=&#39;...&#39;)</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">.view()</span></code> has a second meaning: it can make an ndarray an instance
of a specialized ndarray subclass</p>
</div>
</div>
<div class="section" id="masked-array-missing-data">
<h3><a class="toc-backref" href="#id21">2.2.4.2. <code class="xref py py-class docutils literal notranslate"><span class="pre">masked_array</span></code> missing data</a><a class="headerlink" href="#masked-array-missing-data" title="Permalink to this headline">¶</a></h3>
<p>Masked arrays are arrays that may have missing or invalid entries.</p>
<p>For example, suppose we have an array where the fourth entry is invalid:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<div class="newline"></div></pre></div>
</div>
<p>One way to describe this is to create a masked array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span>
<div class="newline"></div><span class="go">masked_array(data=[1, 2, 3, --, 5],</span>
<div class="newline"></div><span class="go">             mask=[False, False, False,  True, False],</span>
<div class="newline"></div><span class="go">       fill_value=999999)</span>
<div class="newline"></div></pre></div>
</div>
<p>Masked mean ignores masked data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<div class="newline"></div><span class="go">2.75</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mx</span><span class="p">)</span>
<div class="newline"></div><span class="go">2.75</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Not all NumPy functions respect masks, for instance
<code class="docutils literal notranslate"><span class="pre">np.dot</span></code>, so check the return types.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">masked_array</span></code> returns a <strong>view</strong> to the original array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<div class="newline"></div><span class="go">array([  1,   9,   3, -99,   5])</span>
<div class="newline"></div></pre></div>
</div>
<div class="section" id="the-mask">
<h4>The mask<a class="headerlink" href="#the-mask" title="Permalink to this headline">¶</a></h4>
<p>You can modify the mask by assigning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span>
<div class="newline"></div><span class="go">masked_array(data=[1, --, 3, --, 5],</span>
<div class="newline"></div><span class="go">             mask=[False,  True, False,  True, False],</span>
<div class="newline"></div><span class="go">       fill_value=999999)</span>
<div class="newline"></div></pre></div>
</div>
<p>The mask is cleared on assignment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span>
<div class="newline"></div><span class="go">masked_array(data=[1, 9, 3, --, 5],</span>
<div class="newline"></div><span class="go">             mask=[False, False, False,  True, False],</span>
<div class="newline"></div><span class="go">       fill_value=999999)</span>
<div class="newline"></div></pre></div>
</div>
<p>The mask is also available directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span><span class="o">.</span><span class="n">mask</span>
<div class="newline"></div><span class="go">array([False, False, False,  True, False])</span>
<div class="newline"></div></pre></div>
</div>
<p>The masked entries can be filled with a given value to get an usual
array back:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x2</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">x2</span>
<div class="newline"></div><span class="go">array([ 1,  9,  3, -1,  5])</span>
<div class="newline"></div></pre></div>
</div>
<p>The mask can also be cleared:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">nomask</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">mx</span>
<div class="newline"></div><span class="go">masked_array(data=[1, 9, 3, -99, 5],</span>
<div class="newline"></div><span class="go">             mask=[False, False, False, False, False],</span>
<div class="newline"></div><span class="go">       fill_value=999999)</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="domain-aware-functions">
<h4>Domain-aware functions<a class="headerlink" href="#domain-aware-functions" title="Permalink to this headline">¶</a></h4>
<p>The masked array package also contains domain-aware functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">]))</span>
<div class="newline"></div><span class="go">masked_array(data=[0.0, 0.6931471805599453, --, --, 1.0986122886681098, --],</span>
<div class="newline"></div><span class="go">             mask=[False, False,  True,  True, False,  True],</span>
<div class="newline"></div><span class="go">       fill_value=1e+20)</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Streamlined and more seamless support for dealing with missing data
in arrays is making its way into NumPy 1.7.  Stay tuned!</p>
</div>
<div class="topic">
<p class="topic-title">Example: Masked statistics</p>
<p>Canadian rangers were distracted when counting hares and lynxes in
1903-1910 and 1917-1918, and got the numbers are wrong. (Carrot
farmers stayed alert, though.)  Compute the mean populations over
time, ignoring the invalid numbers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/populations.txt&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">populations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">year</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_years</span> <span class="o">=</span> <span class="p">(((</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">1903</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">1910</span><span class="p">))</span>
<div class="newline"></div><span class="gp">... </span>           <span class="o">|</span> <span class="p">((</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">1917</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">1918</span><span class="p">)))</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="c1"># &#39;&amp;&#39; means &#39;and&#39; and &#39;|&#39; means &#39;or&#39;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">populations</span><span class="p">[</span><span class="n">bad_years</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">populations</span><span class="p">[</span><span class="n">bad_years</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">populations</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<div class="newline"></div><span class="go">masked_array(data=[40472.72727272727, 18627.272727272728, 42400.0],</span>
<div class="newline"></div><span class="go">             mask=[False, False, False],</span>
<div class="newline"></div><span class="go">       fill_value=1e+20)</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">populations</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<div class="newline"></div><span class="go">masked_array(data=[21087.656489006717, 15625.799814240254, 3322.5062255844787],</span>
<div class="newline"></div><span class="go">             mask=[False, False, False],</span>
<div class="newline"></div><span class="go">       fill_value=1e+20)</span>
<div class="newline"></div></pre></div>
</div>
<p>Note that Matplotlib knows about masked arrays:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">populations</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>   
<div class="newline"></div><span class="go">[&lt;matplotlib.lines.Line2D object at ...&gt;, ...]</span>
<div class="newline"></div></pre></div>
</div>
</div>
<a class="reference external image-reference" href="auto_examples/plot_maskedstats.html"><img alt="../../_images/sphx_glr_plot_maskedstats_001.png" class="align-center" src="../../_images/sphx_glr_plot_maskedstats_001.png" style="width: 50%;" /></a>
</div>
</div>
<div class="section" id="recarray-purely-convenience">
<h3><a class="toc-backref" href="#id22">2.2.4.3. <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.recarray.html#numpy.recarray" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">recarray</span></code></a>: purely convenience</a><a class="headerlink" href="#recarray-purely-convenience" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">arr2</span><span class="o">.</span><span class="n">x</span>       
<div class="newline"></div><span class="go">chararray([&#39;a&#39;, &#39;b&#39;],</span>
<div class="newline"></div><span class="go">      dtype=&#39;|S1&#39;)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">arr2</span><span class="o">.</span><span class="n">y</span>
<div class="newline"></div><span class="go">array([1, 2])</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="matrix-convenience">
<h3><a class="toc-backref" href="#id23">2.2.4.4. <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.matrix.html#numpy.matrix" title="(in NumPy v1.23)"><code class="xref py py-class docutils literal notranslate"><span class="pre">matrix</span></code></a>: convenience?</a><a class="headerlink" href="#matrix-convenience" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>always 2-D</li>
<li><code class="docutils literal notranslate"><span class="pre">*</span></code> is the matrix product, not the elementwise one</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
<div class="newline"></div><span class="go">matrix([[1, 2],</span>
<div class="newline"></div><span class="go">        [3, 4]])</span>
<div class="newline"></div></pre></div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id24">2.2.5. Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Anatomy of the ndarray: data, dtype, strides.</li>
<li>Universal functions: elementwise operations, how to make new ones</li>
<li>Ndarray subclasses</li>
<li>Various buffer interfaces for integration with other tools</li>
<li>Recent additions: PEP 3118, generalized ufuncs</li>
</ul>
</div>
<div class="section" id="contributing-to-numpy-scipy">
<h2><a class="toc-backref" href="#id25">2.2.6. Contributing to NumPy/Scipy</a><a class="headerlink" href="#contributing-to-numpy-scipy" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>Get this tutorial: <a class="reference external" href="http://www.euroscipy.org/talk/882">http://www.euroscipy.org/talk/882</a></div></blockquote>
<div class="section" id="why">
<h3><a class="toc-backref" href="#id26">2.2.6.1. Why</a><a class="headerlink" href="#why" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>“There’s a bug?”</li>
<li>“I don’t understand what this is supposed to do?”</li>
<li>“I have this fancy code. Would you like to have it?”</li>
<li>“I’d like to help! What can I do?”</li>
</ul>
</div>
<div class="section" id="reporting-bugs">
<h3><a class="toc-backref" href="#id27">2.2.6.2. Reporting bugs</a><a class="headerlink" href="#reporting-bugs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Bug tracker (prefer <strong>this</strong>)<ul>
<li><a class="reference external" href="https://github.com/numpy/numpy/issues">https://github.com/numpy/numpy/issues</a></li>
<li><a class="reference external" href="https://github.com/scipy/scipy/issues">https://github.com/scipy/scipy/issues</a></li>
<li>Click the “Register” link to get an account</li>
</ul>
</li>
<li>Mailing lists ( scipy.org/Mailing_Lists )<ul>
<li>If you’re unsure</li>
<li>No replies in a week or so? Just file a bug ticket.</li>
</ul>
</li>
</ul>
<div class="section" id="good-bug-report">
<h4>Good bug report<a class="headerlink" href="#good-bug-report" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Title</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutations</span> <span class="n">fails</span> <span class="k">for</span> <span class="n">non</span><span class="o">-</span><span class="n">integer</span> <span class="n">arguments</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">I</span><span class="s1">&#39;m trying to generate random permutations, using numpy.random.permutations</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">When</span> <span class="n">calling</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span> <span class="k">with</span> <span class="n">non</span><span class="o">-</span><span class="n">integer</span> <span class="n">arguments</span>
<div class="newline"></div><span class="n">it</span> <span class="n">fails</span> <span class="k">with</span> <span class="n">a</span> <span class="n">cryptic</span> <span class="n">error</span> <span class="n">message</span><span class="p">::</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="o">&gt;&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<div class="newline"></div>    <span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">])</span>
<div class="newline"></div>    <span class="o">&gt;&gt;&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="mf">12.</span><span class="p">)</span> <span class="c1">#doctest: +SKIP</span>
<div class="newline"></div>    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<div class="newline"></div>      <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<div class="newline"></div>      <span class="n">File</span> <span class="s2">&quot;mtrand.pyx&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3311</span><span class="p">,</span> <span class="ow">in</span> <span class="n">mtrand</span><span class="o">.</span><span class="n">RandomState</span><span class="o">.</span><span class="n">permutation</span>
<div class="newline"></div>      <span class="n">File</span> <span class="s2">&quot;mtrand.pyx&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3254</span><span class="p">,</span> <span class="ow">in</span> <span class="n">mtrand</span><span class="o">.</span><span class="n">RandomState</span><span class="o">.</span><span class="n">shuffle</span>
<div class="newline"></div>    <span class="ne">TypeError</span><span class="p">:</span> <span class="nb">len</span><span class="p">()</span> <span class="n">of</span> <span class="n">unsized</span> <span class="nb">object</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">This</span> <span class="n">also</span> <span class="n">happens</span> <span class="k">with</span> <span class="n">long</span> <span class="n">arguments</span><span class="p">,</span> <span class="ow">and</span> <span class="n">so</span>
<div class="newline"></div><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="n">where</span> <span class="n">X</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">array</span> <span class="n">fails</span> <span class="n">on</span> <span class="mi">64</span>
<div class="newline"></div><span class="n">bit</span> <span class="n">windows</span> <span class="p">(</span><span class="n">where</span> <span class="n">shape</span> <span class="ow">is</span> <span class="n">a</span> <span class="nb">tuple</span> <span class="n">of</span> <span class="n">longs</span><span class="p">)</span><span class="o">.</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">It</span> <span class="n">would</span> <span class="n">be</span> <span class="n">great</span> <span class="k">if</span> <span class="n">it</span> <span class="n">could</span> <span class="n">cast</span> <span class="n">to</span> <span class="n">integer</span> <span class="ow">or</span> <span class="n">at</span> <span class="n">least</span> <span class="k">raise</span> <span class="n">a</span>
<div class="newline"></div><span class="n">proper</span> <span class="n">error</span> <span class="k">for</span> <span class="n">non</span><span class="o">-</span><span class="n">integer</span> <span class="n">types</span><span class="o">.</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">I</span><span class="s1">&#39;m using NumPy 1.4.1, built from the official tarball, on Windows</span>
<div class="newline"></div><span class="mi">64</span> <span class="k">with</span> <span class="n">Visual</span> <span class="n">studio</span> <span class="mi">2008</span><span class="p">,</span> <span class="n">on</span> <span class="n">Python</span><span class="o">.</span><span class="n">org</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">Python</span><span class="o">.</span>
<div class="newline"></div></pre></div>
</div>
<ol class="arabic" start="0">
<li><p class="first">What are you trying to do?</p>
</li>
<li><p class="first"><strong>Small code snippet reproducing the bug</strong> (if possible)</p>
<ul class="simple">
<li>What actually happens</li>
<li>What you’d expect</li>
</ul>
</li>
<li><p class="first">Platform (Windows / Linux / OSX, 32/64 bits, x86/PPC, …)</p>
</li>
<li><p class="first">Version of NumPy/Scipy</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> 
<div class="newline"></div><span class="go">1...</span>
<div class="newline"></div></pre></div>
</div>
<p><strong>Check that the following is what you expect</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span> 
<div class="newline"></div><span class="go">/...</span>
<div class="newline"></div></pre></div>
</div>
<p>In case you have old/broken NumPy installations lying around.</p>
<p>If unsure, try to remove existing NumPy installations, and reinstall…</p>
</li>
</ol>
</div>
</div>
<div class="section" id="contributing-to-documentation">
<h3><a class="toc-backref" href="#id28">2.2.6.3. Contributing to documentation</a><a class="headerlink" href="#contributing-to-documentation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Documentation editor</p>
<ul>
<li><p class="first"><a class="reference external" href="http://docs.scipy.org/doc/numpy">http://docs.scipy.org/doc/numpy</a></p>
</li>
<li><p class="first">Registration</p>
<ul>
<li><p class="first">Register an account</p>
</li>
<li><p class="first">Subscribe to <code class="docutils literal notranslate"><span class="pre">scipy-dev</span></code> mailing list  (subscribers-only)</p>
</li>
<li><p class="first">Problem with mailing lists: you get mail</p>
<ul>
<li><p class="first">But: <strong>you can turn mail delivery off</strong></p>
</li>
<li><p class="first">“change your subscription options”, at the bottom of</p>
<p><a class="reference external" href="http://mail.python.org/mailman/listinfo/scipy-dev">http://mail.python.org/mailman/listinfo/scipy-dev</a></p>
</li>
</ul>
</li>
<li><p class="first">Send a mail &#64; <code class="docutils literal notranslate"><span class="pre">scipy-dev</span></code> mailing list; ask for activation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">To</span><span class="p">:</span> <span class="n">scipy</span><span class="o">-</span><span class="n">dev</span><span class="nd">@scipy</span><span class="o">.</span><span class="n">org</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">Hi</span><span class="p">,</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">I</span><span class="s1">&#39;d like to edit NumPy/Scipy docstrings. My account is XXXXX</span>
<div class="newline"></div>
<div class="newline"></div><span class="n">Cheers</span><span class="p">,</span>
<div class="newline"></div><span class="n">N</span><span class="o">.</span> <span class="n">N</span><span class="o">.</span>
<div class="newline"></div></pre></div>
</div>
</li>
</ul>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Check the style guide:<ul>
<li><a class="reference external" href="http://docs.scipy.org/doc/numpy/">http://docs.scipy.org/doc/numpy/</a></li>
<li>Don’t be intimidated; to fix a small thing, just fix it</li>
</ul>
</li>
<li>Edit</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Edit sources and send patches (as for bugs)</p>
</li>
<li><p class="first">Complain on the mailing list</p>
</li>
</ol>
</div>
<div class="section" id="contributing-features">
<h3><a class="toc-backref" href="#id29">2.2.6.4. Contributing features</a><a class="headerlink" href="#contributing-features" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>The contribution of features is documented on <a class="reference external" href="https://docs.scipy.org/doc/numpy/dev/">https://docs.scipy.org/doc/numpy/dev/</a></div></blockquote>
</div>
<div class="section" id="how-to-help-in-general">
<h3><a class="toc-backref" href="#id30">2.2.6.5. How to help, in general</a><a class="headerlink" href="#how-to-help-in-general" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Bug fixes always welcome!</p>
<ul class="simple">
<li>What irks you most</li>
<li>Browse the tracker</li>
</ul>
</li>
<li><p class="first">Documentation work</p>
<ul>
<li><p class="first">API docs: improvements to docstrings</p>
<ul class="simple">
<li>Know some Scipy module well?</li>
</ul>
</li>
<li><p class="first"><em>User guide</em></p>
<ul>
<li><p class="first">Needs to be done eventually.</p>
</li>
<li><p class="first">Want to think? Come up with a Table of Contents</p>
<p><a class="reference external" href="http://scipy.org/Developer_Zone/UG_Toc">http://scipy.org/Developer_Zone/UG_Toc</a></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">Ask on communication channels:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">numpy-discussion</span></code> list</li>
<li><code class="docutils literal notranslate"><span class="pre">scipy-dev</span></code> list</li>
</ul>
</li>
</ul>
<p><div style="clear: both"></div></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2.2. Advanced NumPy</a><ul>
<li><a class="reference internal" href="#life-of-ndarray">2.2.1. Life of ndarray</a><ul>
<li><a class="reference internal" href="#it-s">2.2.1.1. It’s…</a></li>
<li><a class="reference internal" href="#block-of-memory">2.2.1.2. Block of memory</a></li>
<li><a class="reference internal" href="#data-types">2.2.1.3. Data types</a><ul>
<li><a class="reference internal" href="#the-descriptor">The descriptor</a></li>
<li><a class="reference internal" href="#example-reading-wav-files">Example: reading <code class="docutils literal notranslate"><span class="pre">.wav</span></code> files</a></li>
<li><a class="reference internal" href="#casting-and-re-interpretation-views">Casting and re-interpretation/views</a><ul>
<li><a class="reference internal" href="#casting">Casting</a></li>
<li><a class="reference internal" href="#re-interpretation-viewing">Re-interpretation / viewing</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#indexing-scheme-strides">2.2.1.4. Indexing scheme: strides</a><ul>
<li><a class="reference internal" href="#main-point">Main point</a><ul>
<li><a class="reference internal" href="#c-and-fortran-order">C and Fortran order</a></li>
<li><a class="reference internal" href="#slicing-with-integers">Slicing with integers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-fake-dimensions-with-strides">Example: fake dimensions with strides</a></li>
<li><a class="reference internal" href="#broadcasting">Broadcasting</a></li>
<li><a class="reference internal" href="#more-tricks-diagonals">More tricks: diagonals</a></li>
<li><a class="reference internal" href="#cpu-cache-effects">CPU cache effects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#findings-in-dissection">2.2.1.5. Findings in dissection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#universal-functions">2.2.2. Universal functions</a><ul>
<li><a class="reference internal" href="#what-they-are">2.2.2.1. What they are?</a><ul>
<li><a class="reference internal" href="#parts-of-an-ufunc">Parts of an Ufunc</a></li>
<li><a class="reference internal" href="#making-it-easier">Making it easier</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercise-building-an-ufunc-from-scratch">2.2.2.2. Exercise: building an ufunc from scratch</a></li>
<li><a class="reference internal" href="#solution-building-an-ufunc-from-scratch">2.2.2.3. Solution: building an ufunc from scratch</a></li>
<li><a class="reference internal" href="#generalized-ufuncs">2.2.2.4. Generalized ufuncs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#interoperability-features">2.2.3. Interoperability features</a><ul>
<li><a class="reference internal" href="#sharing-multidimensional-typed-data">2.2.3.1. Sharing multidimensional, typed data</a></li>
<li><a class="reference internal" href="#the-old-buffer-protocol">2.2.3.2. The old buffer protocol</a></li>
<li><a class="reference internal" href="#id2">2.2.3.3. The old buffer protocol</a></li>
<li><a class="reference internal" href="#array-interface-protocol">2.2.3.4. Array interface protocol</a></li>
</ul>
</li>
<li><a class="reference internal" href="#array-siblings-chararray-maskedarray-matrix">2.2.4. Array siblings: <code class="docutils literal notranslate"><span class="pre">chararray</span></code>, <code class="docutils literal notranslate"><span class="pre">maskedarray</span></code>, <code class="docutils literal notranslate"><span class="pre">matrix</span></code></a><ul>
<li><a class="reference internal" href="#chararray-vectorized-string-operations">2.2.4.1. <code class="docutils literal notranslate"><span class="pre">chararray</span></code>: vectorized string operations</a></li>
<li><a class="reference internal" href="#masked-array-missing-data">2.2.4.2. <code class="docutils literal notranslate"><span class="pre">masked_array</span></code> missing data</a><ul>
<li><a class="reference internal" href="#the-mask">The mask</a></li>
<li><a class="reference internal" href="#domain-aware-functions">Domain-aware functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#recarray-purely-convenience">2.2.4.3. <code class="docutils literal notranslate"><span class="pre">recarray</span></code>: purely convenience</a></li>
<li><a class="reference internal" href="#matrix-convenience">2.2.4.4. <code class="docutils literal notranslate"><span class="pre">matrix</span></code>: convenience?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">2.2.5. Summary</a></li>
<li><a class="reference internal" href="#contributing-to-numpy-scipy">2.2.6. Contributing to NumPy/Scipy</a><ul>
<li><a class="reference internal" href="#why">2.2.6.1. Why</a></li>
<li><a class="reference internal" href="#reporting-bugs">2.2.6.2. Reporting bugs</a><ul>
<li><a class="reference internal" href="#good-bug-report">Good bug report</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contributing-to-documentation">2.2.6.3. Contributing to documentation</a></li>
<li><a class="reference internal" href="#contributing-features">2.2.6.4. Contributing features</a></li>
<li><a class="reference internal" href="#how-to-help-in-general">2.2.6.5. How to help, in general</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../advanced_python/index.html"
                        title="previous chapter">2.1. Advanced Python Constructs</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../debugging/index.html"
                        title="next chapter">2.3. Debugging code</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/advanced/advanced_numpy/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../debugging/index.html" title="2.3. Debugging code"
             >next</a></li>
        <li class="right" >
          <a href="../advanced_python/index.html" title="2.1. Advanced Python Constructs"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Scipy lecture notes</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >2. Advanced topics</a> &#187;</li>
     
    <!-- Insert a menu in the navigation bar -->
    <li class="left">
	<!-- On click toggle the 'tip' on or off-->
	<a onclick="$('.tip').each(function (index, obj) {
			    collapse_tip_div(obj);
		    });
		    $('.tip').addClass('collapsed');
		    $('.left').addClass('transparent');">
	<img src="../../_static/minus.png"
         alt="Collapse to compact view" style="padding: 1ex;"/>
	<span class="hiddenlink">Collapse document to compact view</span>
    </a></li>
    <li class="right edit_on_github"><a href="https://github.com/scipy-lectures/scipy-lecture-notes/edit/master/advanced/advanced_numpy/index.rst">Edit
    <span class="tooltip">
	Improve this page:<br/>Edit it on Github.
    </span>
    </a>
    </li>

      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012,2013,2015,2016,2017,2018,2019,2020,2021,2022.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.
    </div>
  </body>
</html>